<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>History Table</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Prompt', sans-serif; background: #f5f5f5; padding: 20px; }
  h2 { text-align: center; color: #333; }
  .controls { margin-bottom: 20px; text-align: center; }
  .controls input { padding: 6px; margin: 0 5px; border-radius: 4px; border: 1px solid #ccc; }
  .controls button { padding: 6px 12px; border-radius: 4px; border: none; background: #007bff; color: #fff; cursor: pointer; }
  .controls button:hover { background: #0056b3; }
  table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
  th { background-color: #007bff; color: white; }
  tbody tr:hover { background-color: #f1f1f1; }
  td img { max-width: 80px; height: auto; border-radius: 4px; }
</style>
</head>
<body>

<h2>History Table</h2>

<div class="controls">
  <label>จากวันที่: <input type="date" id="startDate"></label>
  <label>ถึงวันที่: <input type="date" id="endDate"></label>
  <button onclick="filterData()">กรอง</button>
</div>

<table id="historyTable">
  <thead>
    <tr>
      <th>A</th><th>B</th><th>C</th><th>D</th><th>E</th>
      <th>F</th><th>G</th><th>H</th><th>I</th><th>J</th>
      <th>K</th><th>L</th><th>M</th><th>N</th><th>O</th>
      <th>P</th><th>Q</th><th>R</th><th>S</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const webAppURL = 'https://script.google.com/macros/s/AKfycbx2Y2ChK_CSCUr5xOe5TX0dxSIbOjtnFNWCwqUFRroi2OtLQgDRfxGX41k2O2DHm1Mt/exec';
let allData = []; // เก็บข้อมูลทั้งหมด

// โหลดข้อมูลทั้งหมดจาก Web App
function loadData() {
  fetch(webAppURL)
    .then(response => response.json())
    .then(data => {
      allData = data;
      renderTable(allData);
    })
    .catch(err => console.error("Error fetching data:", err));
}

// กรอง Column L ตาม ISO Date
function filterData() {
  const startDateStr = document.getElementById('startDate').value;
  const endDateStr = document.getElementById('endDate').value;
  if (!startDateStr || !endDateStr) {
    alert("กรุณาเลือกช่วงวันที่");
    return;
  }

  const startDate = new Date(startDateStr);
  const endDate = new Date(endDateStr);
  startDate.setHours(0,0,0,0);
  endDate.setHours(23,59,59,999);

  const filtered = allData.filter(row => {
    const colL = row[11]; // Column L
    if (!colL) return false;
    const rowDate = new Date(colL); // รองรับ ISO format
    return rowDate >= startDate && rowDate <= endDate;
  });

  renderTable(filtered);
}

// แสดงตารางและ Column N เป็นรูปภาพ
function renderTable(data) {
  const tbody = document.querySelector("#historyTable tbody");
  tbody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    row.forEach((cell, index) => {
      const td = document.createElement("td");
      if(index === 13 && cell) { // Column N
        const img = document.createElement("img");
        img.src = `https://drive.google.com/uc?export=view&id=${cell}`;
        td.appendChild(img);
      } else {
        td.textContent = cell;
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

// ตั้ง default วันที่: วันนี้ และย้อนหลัง 31 วัน
window.onload = function() {
  const today = new Date();
  const pastDate = new Date();
  pastDate.setDate(today.getDate() - 31);

  document.getElementById('startDate').value = pastDate.toISOString().slice(0,10);
  document.getElementById('endDate').value = today.toISOString().slice(0,10);

  loadData();
};
</script>

</body>
</html>
