<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ฟอร์มลาออนไลน์</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body {
    font-family: 'Prompt', sans-serif;
    margin: 20px;
}
form {
    max-width: 700px;
    margin: auto;
}
label {
    display: block;
    margin-top: 10px;
}
input, select, textarea {
    width: 100%;
    padding: 5px;
    margin-top: 5px;
    box-sizing: border-box;
}
button {
    margin-top: 15px;
    padding: 10px 20px;
    font-size: 16px;
}
</style>
</head>
<body>

<h2 style="text-align:center;">ฟอร์มลาออนไลน์</h2>

<form id="leaveForm">
    <label>ชื่อ - สกุล
        <input type="text" id="fullName" required>
    </label>
    <label>รหัสพนักงาน
        <input type="text" id="empId" required>
    </label>
    <label>ตำแหน่ง
        <input type="text" id="position" required>
    </label>
    <label>ฝ่าย
        <input type="text" id="department" required>
    </label>
    <label>สังกัดบริษัท (M, P, I, T)
        <input type="text" id="company1" maxlength="1" required>
    </label>
    <label>ประเภทการลา
        <select id="leaveType" required>
            <option value="">-- เลือกประเภทการลา --</option>
            <option value="sick">ลาป่วย (SL)</option>
            <option value="personal">ลากิจ (BL)</option>
            <option value="vacation">ลาพักร้อน (AL)</option>
        </select>
    </label>
    <label>เหตุผล
        <textarea id="reason"></textarea>
    </label>
    <label>ลาตั้งแต่วันที่
        <input type="date" id="startDate">
        เวลา <input type="time" id="startTime">
    </label>
    <label>ถึงวันที่
        <input type="date" id="endDate">
        เวลา <input type="time" id="endTime">
    </label>
    <label>จำนวนวันลา
        <input type="number" id="sumDate" min="0">
    </label>
    <label>เอกสารประกอบ
        <select id="paper">
            <option value="Yes">มี</option>
            <option value="No">ไม่มี</option>
        </select>
    </label>
    <label>ยอดสะสม SL
        <input type="number" id="SL" value="0">
    </label>
    <label>ยอดสะสม AL
        <input type="number" id="AL" value="0">
    </label>
    <label>ยอดสะสม BL
        <input type="number" id="BL" value="0">
    </label>
    <label>รวมทั้งหมด
        <input type="number" id="total" value="0">
    </label>
    <label>วันที่สร้างใบลา
        <input type="date" id="createDate" value="<?= new Date().toISOString().split('T')[0] ?>">
    </label>
    <label>อัปโหลดลายเซ็น
        <input type="file" id="myImage" accept="image/*">
    </label>
    <button type="submit">สร้าง PDF</button>
</form>

<script>
const { jsPDF } = window.jspdf;

// ใส่ Base64 ของฟอนต์ TTF ภาษาไทยที่แปลงแล้ว
const FONT_BASE64 = "ใส่ Base64 ของฟอนต์ Sarabun ที่นี่";

document.getElementById("leaveForm").addEventListener("submit", async (e)=> {
  e.preventDefault();

  const fullName = document.getElementById("fullName").value;
  const empId = document.getElementById("empId").value;
  const position = document.getElementById("position").value;
  const department = document.getElementById("department").value;
  const leaveType = document.getElementById("leaveType").value.trim().toLowerCase();
  const Shift = "-";
  const reason = document.getElementById("reason").value;
  const startDate = document.getElementById("startDate").value;
  const startTime = document.getElementById("startTime").value;
  const endDate = document.getElementById("endDate").value;
  const endTime = document.getElementById("endTime").value;
  const sumDate = document.getElementById("sumDate").value;
  const paper = document.getElementById("paper").value;
  const SL = document.getElementById("SL").value;
  const AL = document.getElementById("AL").value;
  const BL = document.getElementById("BL").value;
  const total = document.getElementById("total").value;
  const createDate = document.getElementById("createDate").value;

  let company1 = document.getElementById("company1").value.trim().toUpperCase();
  const companyMap = {
    "M": "ห้างหุ้นส่วนจำกัด แม่รำพึง ดี แอนด์ ที บีสชิเนส",
    "P": "ห้างหุ้นส่วนจำกัด พชรพล บางสะพาน",
    "I": "บริษัท ทัศนพงศ์ ธุรกิจ จำกัด",
    "T": "ห้างหุ่นส่วนจำกัด ทองหลาง กรุ๊ป"
  };
  const addressMap = {
    "M": "89 หมู่ 5 ต.แม่รำพึง อ.บางสะพาน จ.ประจวบคีรีขันธ์ 77140 โทร. 0-3289-2264, 0-3254-8267",
    "P": "35/6 หมู่ 6 ต.แม่รำพึง อ.บางสะพาน จ.ประจวบคีรีขันธ์ 77140 โทร. 087-9063162, 032-692447",
    "I": "121 หมู่ 5 ต.กำเนิดนพคุณ อ.บางสะพาน จ.ประจวบคีรีขันธ์ 77140 โทร. 032-693326",
    "T": "115/15 หมู่ 6 ต.แม่รำพึง อ.บางสะพาน จ.ประจวบคีรีขันธ์ 77140 โทร. 086-1711018"
  };
  if (companyMap[company1]) company1 = companyMap[company1];
  let address1 = addressMap[company1[0]] || "";

  const doc = new jsPDF();

  doc.addFileToVFS("Sarabun-Regular.ttf", FONT_BASE64);
  doc.addFont("Sarabun-Regular.ttf", "Sarabun", "normal");
  doc.setFont("Sarabun");
  doc.setFontSize(16);

  const pageWidth = doc.internal.pageSize.getWidth();
  doc.text(company1, pageWidth/2, 15, { align: "center" });
  doc.text(address1, pageWidth/2, 22, { align: "center" });
  doc.text("ใบลาหยุดงาน (LEAVE APPLICATION)", pageWidth/2, 35, { align: "center" });

  doc.setFontSize(14);
  doc.text(`ชื่อ-สกุล: ${fullName}`, 20, 52);
  doc.text(`รหัสพนักงาน: ${empId}`, 150, 52);
  doc.text(`ตำแหน่ง: ${position}`, 20, 64);
  doc.text(`ฝ่าย: ${department}`, 150, 64);
  doc.text(`เหตุผล: ${reason}`, 20, 76);
  doc.text(`ลาตั้งแต่: ${startDate} เวลา ${startTime}`, 20, 88);
  doc.text(`ถึงวันที่: ${endDate} เวลา ${endTime}`, 20, 100);
  doc.text(`จำนวนวันลา: ${sumDate}`, 20, 112);

  // แทรกลายเซ็น
  const fileInput = document.getElementById("myImage");
  const file = fileInput.files[0];

  if(file){
    const reader = new FileReader();
    reader.onload = function(e){
      const imgData = e.target.result;
      doc.addImage(imgData, "PNG", 150, 160, 35, 10);
      doc.save(`ใบลา_${fullName}.pdf`);
    };
    reader.readAsDataURL(file);
  } else {
    doc.save(`ใบลา_${fullName}.pdf`);
  }
});
</script>

</body>
</html>
