<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ฟอร์มใบลา</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<h2>ฟอร์มกรอกใบลา</h2>

<form id="leaveForm">
  <label>ชื่อ - สกุล:</label><br>
  <input type="text" id="fullName" placeholder="ชื่อ - สกุล" ><br>
  <label>รหัสพนักงาน:</label><br>
  <input type="text" id="empId" placeholder="รหัสพนักงาน" ><br>
  <label>ตำแหน่ง:</label><br>
  <input type="text" id="position" placeholder="ตำแหน่ง" ><br>
  <label>ฝ่าย:</label><br>
  <input type="text" id="department" placeholder="ฝ่าย" ><br>
  <label>ประเภทการลา (vacation / sick / personal):</label><br>
  <input type="text" id="leaveType" placeholder="เช่น vacation" ><br><br>
  <label>เหตุผล:</label><br>
  <input type="text" id="reason" placeholder="เหตุผล" ><br>
  <label>ลาตั้งแต่วันที่:</label><br>
  <input type="text" id="startDate" placeholder="วันเริ่มต้น" ><br>
  <label>เวลาเริ่ม:</label><br>
  <input type="text" id="startTime" placeholder="เวลาเริ่ม" ><br>
  <label>ถึงวันที่:</label><br>
  <input type="text" id="endDate" placeholder="ถึงวันที่" ><br>
  <label>เวลาสิ้นสุด:</label><br>
  <input type="text" id="endTime" placeholder="เวลาสิ้นสุด" ><br>
  <label>จำนวนวันลา:</label><br>
  <input type="text" id="sumDate" placeholder="จำนวนวันลา" ><br>
  <label>มีเอกสารประกอบ:</label><br>
  <input type="text" id="paper" placeholder="Yes/No" ><br>
  
  <label>SL:</label><br>
  <input type="text" id="SL" placeholder="SL" ><br>
  <label>AL:</label><br>
  <input type="text" id="AL" placeholder="AL" ><br>
  <label>BL:</label><br>
  <input type="text" id="BL" placeholder="BL" ><br>
  <label>total:</label><br>
  <input type="text" id="total" placeholder="total" ><br>
  <label for="myImage">เลือกรูปภาพ:</label><br>
  <input type="file" id="myImage" accept="image/*"><br>
  
  <label>วันทำรายการ:</label><br>
  <input type="text" id="createDate" placeholder="createDate" ><br>
  
  <label>company1:</label><br>
  <input type="text" id="company1" placeholder="company1" ><br>
  <label>company2:</label><br>
  <input type="text" id="company2" placeholder="company2" ><br>
  
  <label>address1:</label><br>
  <input type="text" id="address1" placeholder="address1" ><br>
  <label>address2:</label><br>
  <input type="text" id="address2" placeholder="address2" ><br>
  
  <button type="submit">สร้าง PDF</button>
</form>

<script>
const { jsPDF } = window.jspdf;

// ====== ✅ รับค่า row จาก query string ======
function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

let rowData = null;
if (getQueryParam("row")) {
    rowData = JSON.parse(decodeURIComponent(getQueryParam("row")));

    // Mapping ข้อมูลจาก row[] ไปใส่ input form
    document.getElementById("empId").value       = rowData[0]; // Col A
    document.getElementById("fullName").value    = rowData[1]; // Col B
    document.getElementById("position").value    = rowData[2]; // Col C
    document.getElementById("department").value  = rowData[3]; // Col D

    // LeaveType
    if (rowData[4] === "AL") document.getElementById("leaveType").value = "vacation";
    else if (rowData[4] === "SL") document.getElementById("leaveType").value = "sick";
    else if (rowData[4] === "BL") document.getElementById("leaveType").value = "personal";
    else document.getElementById("leaveType").value = rowData[4];

    // วันที่ + เวลา
    document.getElementById("startDate").value   = formatDate(rowData[5]);
    document.getElementById("startTime").value   = formatTime(rowData[6]);
    document.getElementById("endDate").value     = formatDate(rowData[7]);
    document.getElementById("endTime").value     = formatTime(rowData[8]);
    document.getElementById("sumDate").value     = rowData[9];  // Col J
    document.getElementById("createDate").value  = rowData[11]; // Col L
    document.getElementById("reason").value      = rowData[12]; // Col M

    // Paper Yes/No
    document.getElementById("paper").value       = rowData[14] ? "Yes" : "No"; // Col O

    // ยอดลา
    document.getElementById("SL").value          = rowData[15];
    document.getElementById("AL").value          = rowData[16];
    document.getElementById("BL").value          = rowData[17];
    document.getElementById("total").value       = rowData[18];

    // Company & Address (ตัวอย่างชั่วคราว)
    document.getElementById("company1").value    = rowData[0];
    document.getElementById("company2").value    = rowData[0];
    document.getElementById("address1").value    = rowData[0];
    document.getElementById("address2").value    = rowData[0];

    // โหลดรูปจาก Google Drive ถ้ามี
    if (rowData[13]) {
        const imgUrl = `https://drive.google.com/uc?export=view&id=${rowData[13]}`;
        loadImageToFileInput(imgUrl, document.getElementById("myImage"));
    }
}

// ---- Helper: format date dd/mm/yyyy ----
function formatDate(excelDate) {
    if (!excelDate) return "";
    const d = new Date(excelDate);
    if (isNaN(d)) return excelDate;
    const day = String(d.getDate()).padStart(2,"0");
    const month = String(d.getMonth()+1).padStart(2,"0");
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

// ---- Helper: format time hh:mm ----
function formatTime(excelTime) {
    if (!excelTime) return "";
    const d = new Date(excelTime);
    if (isNaN(d)) return excelTime;
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
}

// ---- Helper: โหลดรูปจาก URL ใส่ input type="file" ----
async function loadImageToFileInput(url, inputElement) {
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        const file = new File([blob], "signature.png", { type: blob.type });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        inputElement.files = dataTransfer.files;
    } catch (err) {
        console.error("โหลดรูปไม่สำเร็จ", err);
    }
}
</script>

</body>
</html>
