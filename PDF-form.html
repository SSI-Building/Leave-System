<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลประวัติการอนุมัติ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ==================== Theme & Color Variables ==================== */
        :root {
            --primary-color: #3f51b5; /* Deeper blue for a professional look */
            --primary-dark: #303f9f;
            --primary-light: #c5cae9;
            --secondary-color: #ff5722;
            --background-color: #f5f7fa; /* Light grey for a clean background */
            --card-background: #ffffff;
            --text-color: #263238;
            --text-light: #78909c;
            --border-color: #e0e0e0;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --box-shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.1);
            --approved-color: #4caf50;
            --rejected-color: #f44336;
            --pending-color: #ff9800;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            line-height: 1.6;
            box-sizing: border-box;
        }

        /* ==================== Main Container & Layout ==================== */
        .container {
            width: 100%;
            margin: 0 auto;
            background-color: var(--card-background);
            border-radius: 16px;
            box-shadow: var(--box-shadow);
            padding: 30px;
            position: relative;
            transition: box-shadow 0.3s ease;
        }
        .container:hover {
            box-shadow: var(--box-shadow-hover);
        }

        h1 {
            text-align: center;
            font-weight: 700;
            margin-bottom: 30px;
            font-size: 2.5em;
            color: var(--primary-color);
            position: relative;
        }
        h1 i {
            margin-right: 15px;
            color: var(--secondary-color);
            font-size: 1.2em;
        }

        /* ==================== Controls & Filters ==================== */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            align-items: center;
        }
        .controls-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            color: var(--text-color);
            font-weight: 500;
            white-space: nowrap;
        }
        label i {
            margin-right: 5px;
            color: var(--text-light);
        }

        input[type="date"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            color: var(--text-color);
            background-color: var(--background-color);
            transition: all 0.3s ease;
        }
        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--primary-light);
            background-color: var(--card-background);
        }

        /* Adjusted button styles to ensure consistent height */
        button,
        .action-button,
        .controls-group button,
        .controls-group .action-button,
        .controls-grid button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 44px; /* Set a fixed height for consistency */
            box-sizing: border-box; /* Include padding in height calculation */
            text-decoration: none; /* For the anchor tag button */
        }

        button:hover,
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #loadDataButton { background-color: var(--primary-color); }
        #loadDataButton:hover { background-color: var(--primary-dark); }
        
        #resetButton { background-color: var(--text-light); }
        #resetButton:hover { background-color: #607d8b; }

        #sortButton { background-color: #42a5f5; }
        #sortButton:hover { background-color: #1e88e5; }
        
        #summaryTableButton { 
            background-color: var(--primary-color); 
            text-decoration: none;
        }

        .action-button {
            padding: 8px 16px;
            font-size: 14px;
            margin: 0 4px;
            box-shadow: none;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .save-button { background-color: var(--approved-color); }
        .save-button:hover { background-color: #388e3c; }
        .save-button:disabled {
            background-color: #a5d6a7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .print-button { background-color: var(--primary-dark); }
        .print-button:hover { background-color: #283593; }
        .print-button:disabled { cursor: not-allowed; opacity: 0.5; transform: none; box-shadow: none; }

        /* ==================== Table Styles ==================== */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: var(--box-shadow);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px; /* Adjust as needed for desktop view */
        }

        table thead th {
            background-color: var(--primary-color);
            color: white;
            padding: 18px 15px;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            font-size: 1em;
            text-transform: uppercase;
        }

        table tbody tr {
            background-color: var(--card-background);
            transition: background-color 0.2s ease, transform 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }
        table tbody tr:hover {
            background-color: #fafafa;
            transform: scale(1.005);
        }
        table tbody tr:last-child {
            border-bottom: none;
        }

        table td {
            padding: 15px;
            text-align: center;
            vertical-align: middle;
        }
        
        .status-cell-content,
        .action-cell-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        /* Adjusted select and button height in table cells */
        .action-cell-content select {
            height: 38px;
        }
        .action-cell-content button {
            height: 38px;
            padding: 8px 12px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            display: inline-block;
            text-align: center;
            white-space: nowrap;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-approved { background-color: var(--approved-color); }
        .status-rejected { background-color: var(--rejected-color); }
        .status-pending { background-color: var(--pending-color); color: #333; }

        /* ==================== Loading Overlay Styles ==================== */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }

        #loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: 500;
            color: var(--text-color);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== Responsive Design ==================== */
        @media (max-width: 992px) {
            h1 { font-size: 2em; }
            .controls-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            table { min-width: 800px; }
        }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .container { padding: 20px; }
            h1 { font-size: 1.8em; }
            .controls-grid { grid-template-columns: 1fr; }
            .controls-group { flex-direction: column; align-items: stretch; }
            .controls-group label { text-align: left; }
            
            table { min-width: 100%; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { 
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            tr {
                border: 1px solid var(--border-color);
                margin-bottom: 15px;
                border-radius: 12px;
                overflow: hidden;
            }
            td {
                border: none;
                position: relative;
                padding-left: 50%;
                text-align: left;
            }
            td::before {
                content: attr(data-label);
                position: absolute;
                left: 15px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: var(--primary-color);
            }

            .action-cell-content {
                justify-content: flex-start;
                padding-left: 15px;
            }
            .action-button {
                width: calc(50% - 8px);
                min-width: 120px;
            }
            .action-cell-content select {
                width: 100%;
                margin-bottom: 10px;
            }
            .action-cell-content button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">กำลังโหลดข้อมูล...</div>
    </div>

    <div class="container">
        <h1><i class="fas fa-file-invoice"></i> ข้อมูลประวัติการอนุมัติ</h1>
        
        <div class="controls-grid">
            <div class="controls-group">
                <label for="startDate"><i class="fas fa-calendar-alt"></i> วันที่เริ่มต้น:</label>
                <input type="date" id="startDate">
            </div>
            <div class="controls-group">
                <label for="endDate"><i class="fas fa-calendar-alt"></i> วันที่สิ้นสุด:</label>
                <input type="date" id="endDate">
            </div>
            <button id="loadDataButton"><i class="fas fa-sync-alt"></i> โหลดข้อมูล</button>
            <button id="resetButton"><i class="fas fa-undo"></i> ตั้งค่าเริ่มต้น</button>
            <a href="SummaryTable.html" class="action-button" id="summaryTableButton">
                <i class="fas fa-table"></i> ดูตารางสรุป
            </a>
        </div>
        
        <div class="controls-grid">
            <div class="controls-group">
                <label for="searchName"><i class="fas fa-user-circle"></i> ชื่อ-สกุล:</label>
                <input type="text" id="searchName" placeholder="ค้นหาชื่อ...">
            </div>
            <div class="controls-group">
                <label for="filterType"><i class="fas fa-tags"></i> ประเภท:</label>
                <select id="filterType">
                    <option value="">ทั้งหมด</option>
                    <option value="AL">ลาพักร้อน</option>
                    <option value="SL">ลาป่วย</option>
                    <option value="BL">ลากิจ</option>
                </select>
            </div>
            <div class="controls-group">
                <label for="filterStatus"><i class="fas fa-clipboard-check"></i> สถานะ:</label>
                <select id="filterStatus">
                    <option value="">ทั้งหมด</option>
                    <option value="Approved">อนุมัติแล้ว</option>
                    <option value="Rejected">ไม่อนุมัติ</option>
                    <option value="Pending">รออนุมัติ</option>
                </select>
            </div>
            <button id="sortButton"><i class="fas fa-sort-amount-down"></i> เรียงล่าสุด → เก่าสุด</button>
        </div>

        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th><i class="fas fa-id-card-alt"></i> รหัสพนักงาน</th>
                        <th><i class="fas fa-user"></i> ชื่อ-สกุล</th>
                        <th><i class="fas fa-clipboard"></i> ประเภทการลา</th>
                        <th><i class="fas fa-calendar-day"></i> ลาตั้งแค่วันที่</th>
                        <th><i class="fas fa-clock"></i> เวลา(เริ่ม)</th>
                        <th><i class="fas fa-calendar-day"></i> ถึงวันที่</th>
                        <th><i class="fas fa-clock"></i> เวลา(สิ้นสุด)</th>
                        <th><i class="fas fa-hourglass-half"></i> จำนวนวันลา</th>
                        <th><i class="fas fa-check-circle"></i> สถานะ</th>
                        <th><i class="fas fa-file-signature"></i> วันที่ยื่นคำร้อง</th>
                        <th><i class="fas fa-cogs"></i> ดำเนินการ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const loadDataButton = document.getElementById('loadDataButton');
            const resetButton = document.getElementById('resetButton');
            const dataTable = document.getElementById('dataTable');
            
            const searchNameInput = document.getElementById('searchName');
            const filterTypeSelect = document.getElementById('filterType');
            const filterStatusSelect = document.getElementById('filterStatus');
            const sortButton = document.getElementById('sortButton');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            const webAppUrl = 'https://script.google.com/macros/s/AKfycbzQo-oIYvbioq2HbKwfGLmDLfeCO1-0yFnbzhuLXfNbtdk4eAcbFTCm-ZqraakPtnki/exec';
            
            let allData = [];
            let sortOrder = 'desc'; 

            function setInitialDates() {
                const today = new Date();
                const fortyDaysBefore = new Date();
                fortyDaysBefore.setDate(today.getDate() - 40);
                
                startDateInput.value = formatDateForInput(fortyDaysBefore);
                endDateInput.value = formatDateForInput(today);
            }

            function formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function formatDateForDisplay(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            
            function showLoading() {
                loadingOverlay.classList.add('visible');
            }

            function hideLoading() {
                loadingOverlay.classList.remove('visible');
            }
            
            async function updateStatus(uuid, newStatus, button) {
                // Disable the button and show loading state
                button.disabled = true;
                showLoading();

                try {
                    const url = `${webAppUrl}?action=update&uuid=${uuid}&status=${newStatus}`;
                    
                    const response = await fetch(url);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        alert(`อัปเดตสถานะ UUID: ${uuid} เป็น ${newStatus} เรียบร้อยแล้ว`);
                        await fetchData(startDateInput.value, endDateInput.value); // Reload data after successful update
                    } else {
                        alert(`เกิดข้อผิดพลาดในการอัปเดต: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                    alert('เกิดข้อผิดพลาดในการอัปเดตสถานะ');
                } finally {
                    // Re-enable the button and hide loading state after the process
                    button.disabled = false;
                    hideLoading();
                }
            }


            function printRow(rowData) { /* Existing print function logic here */ }


            function getLeaveTypeDisplay(leaveType) {
                if (leaveType === 'AL') return 'ลาพักร้อน (AL)';
                if (leaveType === 'SL') return 'ลาป่วย (SL)';
                if (leaveType === 'BL') return 'ลากิจ (BL)';
                return leaveType;
            }
            
            function getStatusDisplay(status) {
                if (status === 'Approved') return 'อนุมัติแล้ว';
                if (status === 'Rejected') return 'ไม่อนุมัติ';
                if (status === 'Pending') return 'รออนุมัติ';
                return status;
            }

            function filterAndSortData() {
                let filteredData = allData;
                
                const searchText = searchNameInput.value.toLowerCase();
                if (searchText) {
                    filteredData = filteredData.filter(row => 
                        (row[1] || '').toLowerCase().includes(searchText)
                    );
                }

                const filterType = filterTypeSelect.value;
                if (filterType) {
                    filteredData = filteredData.filter(row => (row[4] || '') === filterType);
                }

                const filterStatus = filterStatusSelect.value;
                if (filterStatus) {
                    filteredData = filteredData.filter(row => (row[10] || '') === filterStatus);
                }

                filteredData.sort((a, b) => {
                    const dateA = new Date(a[11]);
                    const dateB = new Date(b[11]);
                    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                });
                
                displayTableData(filteredData);
            }

            async function fetchData(startDate, endDate) {
                showLoading();
                try {
                    const oldestDate = new Date(startDate);
                    const newestDate = new Date(endDate);
                    if (oldestDate > newestDate) {
                        alert('วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด โปรดตรวจสอบอีกครั้ง');
                        hideLoading();
                        return;
                    }
                    
                    const url = `${webAppUrl}?action=read&startDate=${startDate}&endDate=${endDate}`;
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.data) {
                        allData = data.data;
                        filterAndSortData();
                    } else {
                        console.error('Error fetching data:', data.message);
                        alert('ไม่สามารถดึงข้อมูลได้ โปรดตรวจสอบ URL หรือการเชื่อมต่อ');
                        allData = [];
                        displayTableData([]);
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    alert('ไม่สามารถดึงข้อมูลได้ โปรดตรวจสอบ URL หรือการเชื่อมต่อ');
                    allData = [];
                    displayTableData([]);
                } finally {
                    hideLoading();
                }
            }

            function displayTableData(data) {
                const tableBody = dataTable.querySelector('tbody');
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.setAttribute('colspan', '11');
                    td.textContent = 'ไม่พบข้อมูลที่ตรงกับเงื่อนไข';
                    td.style.textAlign = 'center';
                    td.style.padding = '20px';
                    tr.appendChild(td);
                    tableBody.appendChild(tr);
                    return;
                }

                data.forEach(rowData => {
                    const tr = document.createElement('tr');
                    
                    const headers = ["รหัสพนักงาน", "ชื่อ-สกุล", "ประเภทการลา", "ลาตั้งแค่วันที่", "เวลา(เริ่ม)", "ถึงวันที่", "เวลา(สิ้นสุด)", "จำนวนวันลา", "สถานะ", "วันที่ยื่นคำร้อง", "ดำเนินการ"];

                    const displayData = [
                        rowData[0] || '',
                        rowData[1] || '',
                        getLeaveTypeDisplay(rowData[4]),
                        formatDateForDisplay(rowData[5]) || '',
                        rowData[6] || '',
                        formatDateForDisplay(rowData[7]) || '',
                        rowData[8] || '',
                        rowData[9] || '',
                        getStatusDisplay(rowData[10]),
                        formatDateForDisplay(rowData[11]) || ''
                    ];

                    displayData.forEach((item, index) => {
                        const td = document.createElement('td');
                        td.setAttribute('data-label', headers[index]);
                        
                        if (headers[index] === "สถานะ") {
                            const statusContent = document.createElement('div');
                            statusContent.classList.add('status-cell-content');
                            
                            const status = rowData[10] || '';
                            const statusSpan = document.createElement('span');
                            statusSpan.textContent = item;
                            statusSpan.classList.add('status-badge');
                            if (status === 'Approved') {
                                statusSpan.classList.add('status-approved');
                            } else if (status === 'Rejected') {
                                statusSpan.classList.add('status-rejected');
                            } else if (status === 'Pending') {
                                statusSpan.classList.add('status-pending');
                            }
                            statusContent.appendChild(statusSpan);
                            td.appendChild(statusContent);
                        } else {
                            td.textContent = item;
                        }

                        tr.appendChild(td);
                    });

                    const actionTd = document.createElement('td');
                    actionTd.setAttribute('data-label', 'ดำเนินการ');
                    
                    const actionContent = document.createElement('div');
                    actionContent.classList.add('action-cell-content');

                    const status = rowData[10] || '';
                    
                    if (status.toLowerCase() === 'pending') { 
                        const statusSelect = document.createElement('select');
                        statusSelect.innerHTML = `
                            <option value="Approved">อนุมัติ</option>
                            <option value="Rejected">ไม่อนุมัติ</option>
                        `;
                        statusSelect.value = status;
                        actionContent.appendChild(statusSelect);
                        
                        const saveButton = document.createElement('button');
                        saveButton.innerHTML = `<i class="fas fa-save"></i> บันทึก`;
                        saveButton.classList.add('action-button', 'save-button');
                        saveButton.addEventListener('click', () => {
                            const newStatus = statusSelect.value;
                            const uuid = rowData[19]; 
                            updateStatus(uuid, newStatus, saveButton);
                        });
                        actionContent.appendChild(saveButton);
                    } else if (status.toLowerCase() === 'approved') {
                        const printButton = document.createElement('button');
                        printButton.innerHTML = `<i class="fas fa-print"></i> Print`;
                        printButton.classList.add('action-button', 'print-button');
                        printButton.addEventListener('click', () => {
                            printButton.disabled = true;
                            
                            try {
                                printRow(rowData);
                            } catch (error) {
                                console.error("Error generating PDF:", error);
                                alert("เกิดข้อผิดพลาดในการสร้างไฟล์ PDF");
                            } finally {
                                setTimeout(() => {
                                    printButton.disabled = false;
                                }, 1000); 
                            }
                        });
                        actionContent.appendChild(printButton);
                    } else {
                        actionContent.textContent = 'เสร็จสิ้น';
                    }
                    
                    actionTd.appendChild(actionContent);
                    tr.appendChild(actionTd);
                    tableBody.appendChild(tr);
                });
            }

            setInitialDates();
            fetchData(startDateInput.value, endDateInput.value);

            loadDataButton.addEventListener('click', () => {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                fetchData(startDate, endDate);
            });

            resetButton.addEventListener('click', () => {
                setInitialDates();
                searchNameInput.value = '';
                filterTypeSelect.value = '';
                filterStatusSelect.value = '';
                sortOrder = 'desc';
                sortButton.innerHTML = `<i class="fas fa-sort-amount-down"></i> เรียงล่าสุด → เก่าสุด`;
                fetchData(startDateInput.value, endDateInput.value);
            });
            
            searchNameInput.addEventListener('input', filterAndSortData);
            filterTypeSelect.addEventListener('change', filterAndSortData);
            filterStatusSelect.addEventListener('change', filterAndSortData);
            
            sortButton.addEventListener('click', () => {
                sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
                sortButton.innerHTML = sortOrder === 'desc' ? `<i class="fas fa-sort-amount-down"></i> เรียงล่าสุด → เก่าสุด` : `<i class="fas fa-sort-amount-up"></i> เรียงเก่าสุด → ล่าสุด`;
                filterAndSortData();
            });
        });
    </script>
</body>
</html>
