<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { font-family: "Prompt", sans-serif; padding: 20px; background: #f5f5f5; }
    .history-card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 1.1em; font-weight: 600; }
    .card-status { padding: 4px 10px; border-radius: 12px; font-size: 0.9em; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .card-info p { margin: 4px 0; font-size: 0.9em; }
    .signature { margin-top: 8px; }
    .signature img { max-width: 150px; border: 1px solid #ddd; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h2>
  <div id="historyList">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    async function main() {
      await liff.init({ liffId: "2007956727-6V7DrnMD" });
      const profile = await liff.getProfile();
      const lineUserId = profile.userId;

      // üîó ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      const webAppUrl = "https://script.google.com/macros/s/AKfycbyMSCCq9FvSx-ovt3dUVkJ525R9YX5wJnZQoBYOsWNbrxpklT0njy5UzmljCrbfTVww/exec";
      try {
        const response = await fetch(`${webAppUrl}?lineUserId=${lineUserId}`);
        const data = await response.json();
        renderHistory(data);
      } catch(err) {
        console.error(err);
        document.getElementById("historyList").innerHTML = "<p>‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>";
      }
    }

    function formatThaiDate(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const months = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
    }

    function renderHistory(data) {
      const list = document.getElementById("historyList");
      if (!data || data.length === 0) {
        list.innerHTML = "<p>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>";
        return;
      }

      list.innerHTML = data.map(item => {
        let statusClass = "status-pending";
        if (item.status === "Approved") statusClass = "status-approved";
        if (item.status === "Rejected") statusClass = "status-rejected";

        return `
          <div class="history-card">
            <div class="card-header">
              <span class="card-title">${item.leaveType} (${item.empName})</span>
              <span class="card-status ${statusClass}">${item.status}</span>
            </div>
            <div class="card-info">
              <p><strong>‡∏¢‡∏∑‡πà‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${formatThaiDate(item.createdAt)}</p>
              <p><strong>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${formatThaiDate(item.startDate)} ${item.startTime || ""} - ${formatThaiDate(item.endDate)} ${item.endTime || ""}</p>
              <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô:</strong> ${item.leaveDays}</p>
              <p><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${item.reason || "-"}</p>
              ${item.hasDocument ? `<p>üìé ‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</p>` : ""}
            </div>
            ${item.signatureUrl ? `
              <div class="signature">
                <p><strong>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô:</strong></p>
                <img src="${item.signatureUrl}">
              </div>` : ""}
          </div>
        `;
      }).join("");
    }

    main();
  </script>
</body>
</html>
