<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ตรวจสอบประวัติการลา (LIFF)</title>
<style>
  /* นำเข้าฟอนต์ Prompt จาก Google Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap');

  /* การตั้งค่าพื้นฐานสำหรับ body */
  body {
    font-family: 'Prompt', sans-serif;
    background-color: #f0f2f5;
    color: #333;
    padding: 16px;
    margin: 0;
  }

  /* จัดรูปแบบสำหรับ heading */
  h2 {
    color: #1a237e;
    text-align: center;
    margin-bottom: 24px;
    font-weight: 600;
    font-size: 1.5rem;
  }
  
  /*
  ==========================================
  รูปแบบ UI แบบใหม่: Card Layout
  ==========================================
  */
  
  /* ตัวห่อหุ้มรายการทั้งหมด */
  .card-container {
    display: flex;
    flex-direction: column;
    gap: 16px; /* ระยะห่างระหว่างการ์ดแต่ละอัน */
  }

  /* การ์ดแต่ละอัน (Item) */
  .card {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 20px;
    transition: transform 0.2s ease-in-out;
  }

  .card:hover {
    transform: translateY(-4px); /* เพิ่ม effect ยกขึ้นเล็กน้อยเมื่อชี้ */
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .leave-type {
    font-size: 1.2rem;
    color: #1a237e;
  }

  .status {
    font-size: 1.1rem;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
  }

  .status.pending { background-color: #fff9c4; color: #fbc02d; }
  .status.approved { background-color: #e8f5e9; color: #2e7d32; }
  .status.rejected { background-color: #ffebee; color: #c62828; }

  /* แถวข้อมูลแต่ละอันในการ์ด */
  .card-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    line-height: 1.5;
    color: #666;
  }

  .card-item:last-child {
    margin-bottom: 0;
  }

  .card-item-label {
    font-weight: 600;
    color: #4a4a4a;
    margin-right: 8px;
    flex-shrink: 0;
  }
  
  .card-item-value {
    word-wrap: break-word;
  }

  /*
  ==========================================
  ส่วนที่เพิ่มใหม่: สำหรับปุ่มดูรายละเอียด
  ==========================================
  */
  .card-footer {
    display: flex;
    justify-content: flex-end; /* จัดปุ่มชิดขวา */
    margin-top: 16px;
  }
  
  .detail-button {
    background-color: #4CAF50; /* สีเขียว */
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-family: 'Prompt', sans-serif;
    font-weight: 600;
    text-align: center;
    transition: background-color 0.3s, transform 0.2s;
  }

  .detail-button:hover {
    background-color: #45a049;
    transform: translateY(-2px);
  }

  .detail-button:active {
    transform: translateY(0);
  }

  /* จัดรูปแบบข้อความแสดงสถานะ */
  .status-message {
    text-align: center;
    padding: 24px;
    font-size: 1.1rem;
    color: #757575;
    background-color: #fff;
    border-radius: 12px;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .status-message.error {
    color: #d32f2f;
  }
</style>
</head>
<body>

  <h2>ตรวจสอบประวัติการลา</h2>

  <div id="dataContainer" class="card-container">
    <div class="status-message">⏳ กำลังโหลด...</div>
  </div>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    function formatDate(datetimeStr) {
      if (!datetimeStr) return '-';
      const dateObj = new Date(datetimeStr);
      if (isNaN(dateObj.getTime())) {
          return '-';
      }
      const day = String(dateObj.getDate()).padStart(2, '0');
      const month = String(dateObj.getMonth() + 1).padStart(2, '0');
      const year = dateObj.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function formatTime(datetimeStr) {
      if (!datetimeStr) return '-';
      const dateObj = new Date(datetimeStr);
      if (isNaN(dateObj.getTime())) {
          return '-';
      }
      const hours = String(dateObj.getHours()).padStart(2, '0');
      const minutes = String(dateObj.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }
    
    function formatDateTime(datetimeStr) {
      if (!datetimeStr) return '-';
      const dateObj = new Date(datetimeStr);
      if (isNaN(dateObj.getTime())) {
          return '-';
      }
      const day = String(dateObj.getDate()).padStart(2, '0');
      const month = String(dateObj.getMonth() + 1).padStart(2, '0');
      const year = dateObj.getFullYear();
      const hours = String(dateObj.getHours()).padStart(2, '0');
      const minutes = String(dateObj.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year}, ${hours}:${minutes}`;
    }

    async function fetchHistory() {
      try {
        await liff.init({ liffId: "2007956727-6V7DrnMD" });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const profile = await liff.getProfile();
        const lineUserId = profile.userId;

        const webAppUrl = "https://script.google.com/macros/s/AKfycbyMSCCq9FvSx-ovt3dUVkJ525R9YX5wJnZQoBYOsWNbrxpklT0njy5UzmljCrbfTVww/exec?lineUserId=" + lineUserId;
        const resp = await fetch(webAppUrl);
        const data = await resp.json();

        const container = document.getElementById("dataContainer");
        container.innerHTML = "";

        if (!data || data.length === 0) {
          container.innerHTML = `<div class="status-message">❌ ไม่พบข้อมูล</div>`;
          return;
        }

        // ==========================================
        // ส่วนที่เพิ่มใหม่: จัดเรียงข้อมูล
        // ==========================================
        data.sort((a, b) => {
            const dateA = new Date(a[11]); // Column L
            const dateB = new Date(b[11]); // Column L
            return dateB - dateA; // เรียงจากล่าสุดไปเก่าสุด
        });

        // ==========================================
        // การแสดงผลยังคงเหมือนเดิม
        // ==========================================
        data.forEach(row => {
          const card = document.createElement("div");
          card.className = "card";
          
          let leaveType = row[4];
          if (leaveType === 'AL') { leaveType = 'ลาพักร้อน'; }
          else if (leaveType === 'SL') { leaveType = 'ลาป่วย'; }
          else if (leaveType === 'BL') { leaveType = 'ลากิจ'; }
          
          let statusText = row[10];
          let statusClass = 'pending';
          if (statusText === 'pending') { statusText = 'รออนุมัติ'; statusClass = 'pending'; }
          else if (statusText === 'Approved') { statusText = 'อนุมัติ'; statusClass = 'approved'; }
          else if (statusText === 'Reject') { statusText = 'ไม่อนุมัติ'; statusClass = 'rejected'; }

          const header = document.createElement('div');
          header.className = 'card-header';
          header.innerHTML = `<span class="leave-type">${leaveType}</span><span class="status ${statusClass}">${statusText}</span>`;
          card.appendChild(header);

          const startDateItem = document.createElement('div');
          startDateItem.className = 'card-item';
          const startDate = formatDate(row[5]);
          const startTime = formatTime(row[6]);
          startDateItem.innerHTML = `<span class="card-item-label">ลาตั้งแต่วันที่:</span><span class="card-item-value">${startDate} เวลา ${startTime}</span>`;
          card.appendChild(startDateItem);

          const endDateItem = document.createElement('div');
          endDateItem.className = 'card-item';
          const endDate = formatDate(row[7]);
          const endTime = formatTime(row[8]);
          endDateItem.innerHTML = `<span class="card-item-label">ถึงวันที่:</span><span class="card-item-value">${endDate} เวลา ${endTime}</span>`;
          card.appendChild(endDateItem);
          
          const totalDaysItem = document.createElement('div');
          totalDaysItem.className = 'card-item';
          totalDaysItem.innerHTML = `<span class="card-item-label">รวม:</span><span class="card-item-value">${row[9] || '-'} วัน</span>`;
          card.appendChild(totalDaysItem);

          const createdDateItem = document.createElement('div');
          createdDateItem.className = 'card-item';
          const createdDateTime = formatDateTime(row[11]);
          createdDateItem.innerHTML = `<span class="card-item-label">วันที่ทำรายการ:</span><span class="card-item-value">${createdDateTime}</span>`;
          card.appendChild(createdDateItem);

          const cardFooter = document.createElement('div');
          cardFooter.className = 'card-footer';
          cardFooter.innerHTML = `<button class="detail-button">ดูรายละเอียด</button>`;
          card.appendChild(cardFooter);

          container.appendChild(card);
        });

      } catch (err) {
        console.error(err);
        document.getElementById("dataContainer").innerHTML =
          `<div class="status-message error">❌ เกิดข้อผิดพลาดในการโหลดข้อมูล</div>`;
      }
    }

    fetchHistory();
  </script>
</body>
</html>
